digraph MIR_Optimization_Pipeline {
    rankdir=TB;
    newrank=true;
    splines=ortho;
    nodesep=0.8;
    ranksep=1.0;
    
    /* Global node style: Wide and Tall for maximum visibility */
    node [shape=box, style="filled,rounded", fontname="Arial", fontsize=16, fillcolor="#f9f9f9", color="#333333", width=4.0, height=1.2, fixedsize=false];
    edge [color="#666666", penwidth=2.0, arrowsize=1.5];

    /* Terminals */
    MIR [shape=ellipse, fillcolor="#e1f5fe", label="MIR IR", width=4.0, height=1.5];
    MachineCode [shape=ellipse, fillcolor="#fff3e0", label="Native Machine Code", width=4.0, height=1.5];

    /* FRONTEND */
    subgraph cluster_frontend {
        label = "Frontend / Core";
        fontsize = 20;
        style = dashed;
        color = "#cccccc";
        Simplify [label="Simplify\n(Lowering MIR)", fillcolor="#e8f5e9", URL="19_mir_implementation.html#the-simplifier-s-toolbox-simplify-func"];
    }

    /* MIDDLE-END */
    subgraph cluster_middle_end {
        label = "Optimizer (Middle-End)";
        fontsize = 20;
        style = dashed;
        color = "#cccccc";
        
        /* Row 1: Setup */
        BuildCFG [label="Build CFG", URL="#the-architect-s-blueprint-build-func-cfg"];
        BuildSSA [label="Build SSA", URL="#the-single-truth-ssa-construction"];
        AddrTrans [label="Address\nTransformation", URL="#from-abstract-to-concrete-address-transformation"];
        BlockCloning [label="Block Cloning", URL="#path-specialization-basic-block-cloning"];
        
        /* Row 2: SSA Opts - HORIZONTAL GROUP (WIDE) */
        subgraph cluster_ssa_opts {
            label = "SSA Optimizations (Horizontal Pipeline)";
            fontsize = 18;
            fillcolor="#fafafa";
            style=filled;
            color="#bbbbbb";
            
            { rank=same; GVN; CopyProp; DSE; DCE1; LICM; }
            
            GVN [label="GVN / CP / RLE", URL="#the-grand-library-global-value-numbering-gvn"];
            CopyProp [label="Copy Propagation", URL="#the-vanishing-act-copy-propagation"];
            DSE [label="Dead Store\nElimination", URL="#cleaning-the-warehouses-dead-store-elimination-dse"];
            DCE1 [label="Dead Code\nElimination"];
            LICM [label="Loop Invariant\nMotion", URL="#escaping-the-loop-loop-invariant-code-motion-licm"];
            
            GVN -> CopyProp -> DSE -> DCE1 -> LICM;
        }
        
        /* Row 3: Teardown */
        PressureRelief [label="Pressure Relief"];
        SSACombine [label="SSA Combine", URL="#the-merging-pass-instruction-combining-ssa-combine"];
        OutSSA [label="Out of SSA", URL="#the-final-handover-conventional-ssa-make-conventional-ssa"];
        JumpOpts [label="Jump Opts", URL="#the-path-smoother-jump-optimization-jump-opt"];
    }

    /* BACKEND */
    subgraph cluster_backend {
        label = "Backend (Target-Specific)";
        fontsize = 20;
        style = dashed;
        color = "#cccccc";
        
        /* Row 4: Backend Pipeline - HORIZONTAL GROUP (WIDE) */
        subgraph cluster_target_gen {
            label = "Target Generation (Horizontal Pipeline)";
            fontsize = 18;
            fillcolor="#fffde7";
            style=filled;
            color="#d4d4d4";
            
            { rank=same; Machinize; BuildLive; BuildConflicts; Coalesce; RA; }
            
            Machinize [label="Machinize", fillcolor="#fff9c4", URL="#handover-to-the-metal-target-translation"];
            BuildLive [label="Build Live Info", URL="#mapping-existence-live-range-analysis"];
            BuildConflicts [label="Build Register\nConflicts", URL="#aggressive-register-coalescing-coalesce"];
            Coalesce [label="Coalesce"];
            RA [label="Register Allocator\n(Linear Scan)", fillcolor="#ffebee", URL="#the-allocation-war-linear-scan-ra"];
            
            Machinize -> BuildLive -> BuildConflicts -> Coalesce -> RA;
        }

        Combine [label="Combine\n(Code Selection)"];
        DCE2 [label="Dead Code\nElimination"];
        GenMachine [label="Generate Machine\nInstructions", fillcolor="#fff9c4"];
    }

    /* Main Vertical Flow and Transitions */
    MIR -> Simplify;
    Simplify -> BuildCFG;
    BuildCFG -> BuildSSA;
    BuildSSA -> AddrTrans;
    AddrTrans -> BlockCloning;
    
    /* Transition to Horizontal SSA Group */
    BlockCloning -> GVN;
    
    /* Transition out of Horizontal SSA Group */
    LICM -> PressureRelief;
    
    /* Middle-End Teardown */
    PressureRelief -> SSACombine;
    SSACombine -> OutSSA;
    OutSSA -> JumpOpts;
    
    /* Transition to Horizontal Backend Group */
    JumpOpts -> Machinize;
    
    /* Transition out of Horizontal Backend Group */
    RA -> Combine;
    
    /* Backend Finalization */
    Combine -> DCE2;
    DCE2 -> GenMachine;
    GenMachine -> MachineCode;
}